<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>å ´åœ°å€Ÿç”¨ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  </style>
  <script>
    // 1. å¾Œç«¯ GAS ç¶²å€ (ç¶­æŒæ‚¨ä¸Šæ¬¡æä¾›çš„ç‰ˆæœ¬)
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwIpfn0Od-T6shTdT79YCPjZ9-49ZOGRl58a-gVwJnI1qXN1m_1xN28F0BQRJQa0mgC_Q/exec";
    
    // 2. âœ… å·²æ›´æ–°ï¼šé€™æ˜¯æ‚¨å‰›å‰›æä¾›çš„æ—¥æ›†åµŒå…¥ç¶²å€
    const CALENDAR_EMBED_URL = "https://calendar.google.com/calendar/embed?src=02c213a0408b579568583642708285d69e8a9c62cb232cb3c1e7aa2d135d33d4%40group.calendar.google.com&ctz=Asia%2FTaipei"; 
  </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-indigo-500 selection:text-white">

  <!-- å·¦å´é¸å–® -->
  <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-20">
    <div class="p-6 border-b border-slate-800 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <i class="ri-building-2-fill text-white"></i>
      </div>
      <div>
        <h1 class="font-bold text-lg tracking-wide">å ´åœ°é ç´„</h1>
        <p class="text-xs text-slate-400">è¨“ç·´ä¸­å¿ƒå…§éƒ¨ç³»çµ±</p>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">åŠŸèƒ½é¸å–®</div>
      <button onclick="switchView('form')" class="nav-btn w-full text-left px-4 py-3 rounded-xl bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 flex items-center gap-3 transition hover:bg-indigo-600 hover:text-white">
        <i class="ri-add-circle-line text-xl"></i>
        <span class="font-medium">æ–°å¢ç”³è«‹</span>
      </button>
      <button onclick="switchView('list')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition">
        <i class="ri-file-list-3-line text-xl"></i>
        <span class="font-medium">é ç´„æ¸…å–®</span>
      </button>
      <button id="exportCsvBtn" class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm mt-4">
        <i class="ri-file-excel-line"></i> åŒ¯å‡ºå ±è¡¨ (CSV)
      </button>
    </nav>

    <div class="p-4 border-t border-slate-800">
      <div class="bg-slate-800 rounded-xl p-4">
        <p class="text-xs text-slate-400">ä»Šæ—¥æ—¥æœŸ</p>
        <p class="text-sm font-bold text-white font-mono" id="currentDateDisplay">Loading...</p>
      </div>
    </div>
  </aside>

  <!-- ä¸»è¦å…§å®¹ -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
    <!-- Mobile Header -->
    <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20">
      <h1 class="font-bold text-slate-800 flex items-center gap-2"><i class="ri-building-2-fill text-indigo-600"></i> å ´åœ°é ç´„</h1>
      <button onclick="$('aside').classList.toggle('hidden'); $('aside').classList.toggle('absolute'); $('aside').classList.toggle('h-full');" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button>
    </header>

    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
      
      <!-- è¡¨å–®é é¢ -->
      <div id="view-form" class="max-w-7xl mx-auto animate-fade-in grid lg:grid-cols-3 gap-6">
        
        <!-- å·¦å´ï¼šå¡«å¯«å€ -->
        <div class="lg:col-span-2 space-y-6">
          <div class="flex justify-between items-end">
            <div>
              <h2 class="text-2xl font-bold text-slate-800">æ–°å¢é ç´„ç”³è«‹</h2>
              <p class="text-slate-500 text-sm mt-1">è³‡æ–™é€å‡ºå¾Œç‚ºã€Œå¾…å¯©æ ¸ã€ï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡æ ¸å‡†ã€‚</p>
            </div>
            <button id="syncBtn" class="text-sm text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 transition flex items-center gap-1">
              <i class="ri-refresh-line"></i> é‡æ–°åŒæ­¥
            </button>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <form id="bookingForm" class="p-6 md:p-8 space-y-6">
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><i class="ri-user-smile-line"></i> ç”³è«‹è³‡æ–™</h3>
                <div class="grid md:grid-cols-2 gap-4">
                  <input id="unit" type="text" class="input-field" placeholder="å€Ÿç”¨å–®ä½ *" required>
                  <input id="contact" type="text" class="input-field" placeholder="è¯çµ¡äººå§“å *" required>
                  <input id="phone" type="tel" class="input-field" placeholder="è¯çµ¡é›»è©± *" required>
                  <input id="email" type="email" class="input-field" placeholder="Email (é€šçŸ¥ç”¨)">
                </div>
              </div>
              <hr class="border-slate-100">
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><i class="ri-map-pin-time-line"></i> å ´åœ°èˆ‡æ™‚é–“</h3>
                <select id="facility" class="input-field" required>
                  <option value="" disabled selected>è«‹é¸æ“‡å ´åœ°...</option>
                  <optgroup label="æ•™å­¸å€åŸŸ"><option>æ•™å®¤701</option><option>æ•™å®¤702</option><option>æ•™å®¤703</option></optgroup>
                  <optgroup label="å¯¦é«”è¨“ç·´å ´"><option>ç©ºå‘¼æ°£è¨“ç·´å ´</option><option>ç‡ƒç‡’æ«ƒ</option><option>ç‡ƒç‡’å®¤</option><option>å¤§ç›´è¨“ç·´å ´</option></optgroup>
                </select>
                
                <div class="grid md:grid-cols-3 gap-4 items-start">
                  <div class="space-y-1">
                    <input id="date" type="date" class="input-field" required>
                  </div>
                  
                  <!-- æ™‚é–“å€å¡Š (å«å…¨å¤©é¸é …) -->
                  <div class="col-span-2 space-y-2">
                    <div class="flex items-center gap-2 p-1 bg-slate-50 rounded border border-slate-200">
                      <input type="checkbox" id="isAllDay" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                      <label for="isAllDay" class="text-sm text-slate-700 font-medium cursor-pointer select-none">å…¨å¤©å€Ÿç”¨ (08:00 - 17:00)</label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <input id="startTime" type="time" class="input-field" required>
                      <input id="endTime" type="time" class="input-field" required>
                    </div>
                    <div id="timeError" class="hidden text-xs text-rose-500 font-bold flex items-center gap-1"><i class="ri-error-warning-line"></i> çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“</div>
                  </div>
                </div>

                <textarea id="purpose" rows="3" class="input-field" placeholder="ç”¨é€”èªªæ˜..."></textarea>
              </div>
              
              <!-- æ‰¹æ¬¡å·¥å…· -->
              <details class="group bg-slate-50 rounded-xl border border-slate-200 p-4">
                <summary class="flex cursor-pointer items-center justify-between font-medium text-slate-600 text-sm"><span class="flex items-center gap-2"><i class="ri-calendar-todo-fill"></i> æ‰¹æ¬¡ç™»è¨˜å·¥å…·</span><i class="ri-arrow-down-s-line group-open:rotate-180 transition"></i></summary>
                <div class="grid grid-cols-2 gap-3 mt-3 border-t border-slate-200 pt-3">
                  <div><label class="text-[10px] text-slate-400 font-bold">èµ·å§‹</label><input id="dateStart" type="date" class="input-field text-sm p-2"></div>
                  <div><label class="text-[10px] text-slate-400 font-bold">çµæŸ</label><input id="dateEnd" type="date" class="input-field text-sm p-2"></div>
                </div>
                <div class="flex items-center gap-2 mt-2"><input id="excludeWeekend" type="checkbox" class="rounded border-slate-300 text-indigo-600"> <label class="text-sm text-slate-600">æ’é™¤å…­æ—¥</label></div>
              </details>

              <button type="submit" id="submitBtn" class="w-full rounded-xl bg-slate-900 text-white py-3.5 text-sm font-bold shadow-lg hover:bg-indigo-600 transition-all flex items-center justify-center gap-2"><i class="ri-send-plane-fill"></i> æäº¤ç”³è«‹</button>
            </form>
          </div>
        </div>

        <!-- å³å´ï¼šå…¬å‘Šèˆ‡æ—¥æ›† -->
        <div class="space-y-6">
          <!-- å…¬å‘Šæ¬„ -->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
             <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider flex items-center gap-2">
               <i class="ri-calendar-2-line text-indigo-500"></i> æœªä¾† 7 å¤©å·²é ç´„æ¦‚æ³
             </h3>
             <div id="weeklyNotice" class="space-y-3 max-h-[200px] overflow-y-auto pr-1">
                <div class="text-sm text-slate-400 italic flex items-center gap-2"><i class="ri-loader-4-line animate-spin"></i> æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...</div>
             </div>
          </div>

          <!-- æ•´åˆæ‚¨çš„æ—¥æ›† -->
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-1 overflow-hidden">
            <iframe id="calendarFrame" src="" style="border:0" width="100%" height="400" frameborder="0" scrolling="no"></iframe>
            <div class="p-2 text-center text-xs text-slate-400 bg-slate-50">
              ğŸ‘† è«‹åƒè€ƒæ—¥æ›†ç©ºç™½æ™‚æ®µé€²è¡Œç”³è«‹
            </div>
          </div>
        </div>
      </div>

      <!-- æ¸…å–®é é¢ -->
      <div id="view-list" class="max-w-6xl mx-auto hidden animate-fade-in">
         <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[85vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
               <h2 class="font-bold text-lg text-slate-700 flex items-center gap-2"><i class="ri-file-list-3-line text-indigo-500"></i> é ç´„ç¸½è¡¨</h2>
               <div class="flex gap-2">
                 <input id="searchInput" type="text" placeholder="æœå°‹..." class="input-field py-1.5 text-sm w-40">
                 <button id="refreshListBtn" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded"><i class="ri-refresh-line"></i></button>
               </div>
            </div>
            <div class="flex-1 overflow-auto">
              <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-500 font-semibold sticky top-0 shadow-sm z-10">
                  <tr><th class="p-4">ç‹€æ…‹</th><th class="p-4">æ—¥æœŸ</th><th class="p-4">æ™‚é–“</th><th class="p-4">å ´åœ°</th><th class="p-4">å–®ä½</th></tr>
                </thead>
                <tbody id="bookingTbody" class="divide-y divide-slate-100"></tbody>
              </table>
            </div>
         </div>
      </div>

    </div>
  </main>

  <div id="toast" class="fixed bottom-8 right-8 px-6 py-4 bg-slate-800 text-white rounded-xl shadow-2xl flex items-center gap-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50"><div id="toastIcon"></div><div><h4 id="toastTitle" class="font-bold text-sm"></h4><p id="toastMsg" class="text-xs text-slate-300"></p></div></div>

  <style>.input-field { width: 100%; border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 0.6rem; font-size: 0.875rem; transition: all 0.2s; } .input-field:focus { border-color: #6366f1; outline: 2px solid #e0e7ff; } .disabled-input { background-color: #f3f4f6; color: #9ca3af; pointer-events: none; }</style>

  <script>
    const $ = (s) => document.querySelector(s);
    let dbData = []; 

    // åˆå§‹åŒ–
    // é€™è£¡æœƒä½¿ç”¨æ‚¨æä¾›çš„ URL ä¾†è¼‰å…¥æ—¥æ›†
    $('#calendarFrame').src = CALENDAR_EMBED_URL;
    $('#currentDateDisplay').textContent = new Date().toISOString().slice(0,10);
    $('#date').value = new Date().toISOString().slice(0,10);
    
    fetchData();

    // --- å…¨å¤©æŒ‰éˆ•é‚è¼¯ ---
    $('#isAllDay').addEventListener('change', (e) => {
      const startEl = $('#startTime');
      const endEl = $('#endTime');
      if(e.target.checked) {
        startEl.value = "08:00";
        endEl.value = "17:00";
        startEl.classList.add('disabled-input'); startEl.readOnly = true;
        endEl.classList.add('disabled-input'); endEl.readOnly = true;
        $('#timeError').classList.add('hidden');
      } else {
        startEl.classList.remove('disabled-input'); startEl.readOnly = false;
        endEl.classList.remove('disabled-input'); endEl.readOnly = false;
      }
    });

    // --- æŠ“å–è³‡æ–™ ---
    async function fetchData() {
       const notice = $('#weeklyNotice');
       notice.innerHTML = '<div class="text-sm text-slate-400 italic flex items-center gap-2"><i class="ri-loader-4-line animate-spin"></i> æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...</div>';
       try {
         const res = await fetch(GAS_ENDPOINT);
         dbData = await res.json();
         updateWeeklyNotice();
         renderList();
         showToast('åŒæ­¥å®Œæˆ', 'å·²å–å¾—æœ€æ–°å ´åœ°ç‹€æ…‹', 'success');
       } catch (e) {
         notice.innerHTML = '<div class="text-sm text-rose-500">åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>';
       }
    }

    $('#syncBtn').onclick = fetchData;
    $('#refreshListBtn').onclick = fetchData;

    // --- è‡ªå‹•è¨ˆç®—å…¬å‘Š (ä¸­æ–‡ç‹€æ…‹ç‰ˆ) ---
    function updateWeeklyNotice() {
      const container = $('#weeklyNotice');
      container.innerHTML = '';
      const today = new Date();
      let hasBooking = false;

      for(let i=0; i<7; i++) {
        const d = new Date(); d.setDate(today.getDate() + i);
        const dateStr = d.toISOString().slice(0,10);
        // ç¯©é¸åŒ…å«ã€Œå·²æ ¸å‡†ã€çš„è³‡æ–™
        const dayBookings = dbData.filter(x => x.date === dateStr && (x.status.includes('å·²æ ¸å‡†')));
        
        if(dayBookings.length > 0) {
          hasBooking = true;
          container.innerHTML += `
            <div class="text-xs border-b border-slate-100 pb-2 last:border-0">
              <div class="font-bold text-indigo-600 mb-1">${dateStr} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})</div>
              <div class="space-y-1">
                ${dayBookings.map(b => `
                  <div class="flex justify-between text-slate-600 bg-slate-50 px-2 py-1 rounded">
                    <span>${b.facility}</span>
                    <span class="font-mono">${b.startTime}-${b.endTime}</span>
                  </div>
                `).join('')}
              </div>
            </div>`;
        }
      }

      if(!hasBooking) {
        container.innerHTML = '<div class="text-sm text-slate-400 py-4 text-center">æœªä¾† 7 å¤©ç›®å‰ç„¡æ ¸å‡†é ç´„<br>ï¼ˆå…¨æ™‚æ®µçš†å¯ç”³è«‹ï¼‰</div>';
      }
    }

    // --- è¡¨å–®é€å‡º ---
    $('#bookingForm').addEventListener('submit', async e => {
      e.preventDefault();
      if($('#endTime').value <= $('#startTime').value) { $('#timeError').classList.remove('hidden'); return; }
      
      const formData = {
        unit: $('#unit').value, contact: $('#contact').value, phone: $('#phone').value, email: $('#email').value,
        facility: $('#facility').value, purpose: $('#purpose').value, 
        date: $('#date').value, startTime: $('#startTime').value, endTime: $('#endTime').value,
        id: crypto.randomUUID()
      };
      
      // æ‰¹æ¬¡è™•ç†
      const dStart = $('#dateStart').value;
      const dEnd = $('#dateEnd').value;
      let dates = [formData.date];
      if(dStart && dEnd) {
        dates = []; let curr = new Date(dStart), end = new Date(dEnd);
        const skipWeekend = $('#excludeWeekend').checked;
        while(curr <= end) {
           const day = curr.getDay();
           if(!skipWeekend || (day!==0 && day!==6)) dates.push(curr.toISOString().slice(0,10));
           curr.setDate(curr.getDate()+1);
        }
      }

      $('#submitBtn').innerHTML = '<i class="ri-loader-4-line animate-spin"></i> è™•ç†ä¸­...';
      
      try {
        for (const d of dates) {
            const finalData = {...formData, date: d};
            await fetch(GAS_ENDPOINT, { method:'POST', mode:'no-cors', body:JSON.stringify(finalData) });
        }

        showToast('ç”³è«‹æˆåŠŸ', `å·²é€å‡º ${dates.length} ç­†ç”³è«‹å¾…å¯©æ ¸`, 'success');
        $('#bookingForm').reset();
        $('#date').value = new Date().toISOString().slice(0,10);
        
        // é‡ç½®å…¨å¤©æŒ‰éˆ•
        $('#isAllDay').checked = false;
        $('#startTime').classList.remove('disabled-input'); $('#startTime').readOnly = false;
        $('#endTime').classList.remove('disabled-input'); $('#endTime').readOnly = false;

        setTimeout(fetchData, 2500); 
      } catch(err) {
        showToast('ç”³è«‹å¤±æ•—', 'è«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
      } finally {
        $('#submitBtn').innerHTML = '<i class="ri-send-plane-fill"></i> æäº¤ç”³è«‹';
      }
    });

    // --- æ¸²æŸ“æ¸…å–® (ä¸­æ–‡ç‹€æ…‹ç‰ˆ) ---
    function renderList() {
      const tbody = $('#bookingTbody');
      tbody.innerHTML = '';
      const filter = $('#searchInput').value.toLowerCase();
      
      const list = dbData
        .filter(x => (x.unit+x.contact+x.facility).toLowerCase().includes(filter))
        .sort((a,b) => (b.date+b.startTime).localeCompare(a.date+a.startTime));

      if(!list.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400">ç›®å‰ç„¡è³‡æ–™</td></tr>';
          return;
      }

      list.forEach(x => {
        const isApproved = x.status.includes('å·²æ ¸å‡†');
        const isConflict = x.status.includes('æ’æœŸ');
        const isRejected = x.status.includes('å·²æ‹’çµ•');
        
        let badgeClass = 'bg-amber-100 text-amber-700'; // å¾…å¯©æ ¸ (é è¨­)
        if(isApproved) badgeClass = 'bg-emerald-100 text-emerald-700';
        if(isConflict) badgeClass = 'bg-rose-100 text-rose-700 font-bold';
        if(isRejected) badgeClass = 'bg-gray-100 text-gray-500 line-through';

        tbody.innerHTML += `
          <tr class="hover:bg-slate-50 border-b border-slate-100">
            <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${x.status}</span></td>
            <td class="p-4 font-mono text-slate-600">${x.date}</td>
            <td class="p-4 font-mono font-bold">${x.startTime}-${x.endTime}</td>
            <td class="p-4">${x.facility}</td>
            <td class="p-4 text-xs text-slate-500">${x.unit}<br>${x.contact}</td>
          </tr>
        `;
      });
    }
    
    $('#searchInput').addEventListener('input', renderList);

    // åŒ¯å‡º CSV
    $('#exportCsvBtn').onclick = () => {
       if(!dbData.length) return showToast('ç„¡è³‡æ–™','ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º','error');
       const csv = '\ufeffç‹€æ…‹,æ—¥æœŸ,é–‹å§‹,çµæŸ,å ´åœ°,å–®ä½,è¯çµ¡äºº,é›»è©±\n' + 
         dbData.map(r => `${r.status},${r.date},${r.startTime},${r.endTime},"${r.facility}","${r.unit}","${r.contact}","${r.phone}"`).join('\n');
       const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`Booking_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    };

    function showToast(t, m, type) {
       const toast = $('#toast');
       $('#toastTitle').textContent = t; $('#toastMsg').textContent = m;
       $('#toastIcon').className = `text-2xl ri-${type==='success'?'checkbox-circle-fill text-emerald-400':'error-warning-fill text-rose-400'}`;
       toast.classList.remove('translate-y-20', 'opacity-0');
       setTimeout(()=>toast.classList.add('translate-y-20', 'opacity-0'), 3000);
    }

    window.switchView = (v) => {
      document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
      $('#view-'+v).classList.remove('hidden');
    };
  </script>
</body>
</html>
