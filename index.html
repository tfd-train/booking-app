<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>場地借用管理系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
  </style>
  <script>
    // 您提供的 GAS 網址
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycby55ZK6KZJ6MLCm9HR_SoAT4pV5VL8BlUYmxDGEDvswrWyITaKzOQG2CE_NHoGmdXIBXA/exec";
  </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-indigo-500 selection:text-white">

  <!-- 側邊欄 Sidebar -->
  <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-20">
    <div class="p-6 border-b border-slate-800 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <i class="ri-building-2-fill text-white"></i>
      </div>
      <div>
        <h1 class="font-bold text-lg tracking-wide">場地預約</h1>
        <p class="text-xs text-slate-400">訓練中心內部系統</p>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">功能選單</div>
      <button onclick="switchView('form')" class="nav-btn w-full text-left px-4 py-3 rounded-xl bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 flex items-center gap-3 transition hover:bg-indigo-600 hover:text-white hover:shadow-lg hover:shadow-indigo-900/20">
        <i class="ri-add-circle-line text-xl"></i>
        <span class="font-medium">新增申請</span>
      </button>
      <button onclick="switchView('list')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition">
        <i class="ri-file-list-3-line text-xl"></i>
        <span class="font-medium">預約清單</span>
        <span id="pendingCount" class="ml-auto text-[10px] bg-amber-500 text-black px-1.5 py-0.5 rounded-full font-bold hidden">0</span>
      </button>

      <div class="mt-8 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">資料管理</div>
      <button id="exportCsvBtn" class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm">
        <i class="ri-file-excel-line"></i> 匯出報表
      </button>
      <button id="exportJsonBtn" class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm">
        <i class="ri-database-2-line"></i> 備份資料
      </button>
      <label class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm cursor-pointer">
        <i class="ri-upload-cloud-line"></i> 復原備份
        <input id="importJsonInput" type="file" accept="application/json" class="hidden"/>
      </label>
    </nav>

    <div class="p-4 border-t border-slate-800">
      <div class="bg-slate-800 rounded-xl p-4 flex items-center gap-3">
        <div class="flex-1">
          <p class="text-xs text-slate-400">今日日期</p>
          <p class="text-sm font-bold text-white font-mono" id="currentDateDisplay">2023-01-01</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- 主要內容區 -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
    
    <!-- Mobile Header -->
    <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20">
      <h1 class="font-bold text-slate-800 flex items-center gap-2">
        <i class="ri-building-2-fill text-indigo-600"></i> 場地預約
      </h1>
      <button onclick="$('aside').classList.toggle('hidden'); $('aside').classList.toggle('absolute'); $('aside').classList.toggle('h-full');" class="text-slate-600 p-2">
        <i class="ri-menu-line text-xl"></i>
      </button>
    </header>

    <!-- 內容 Scroll 區 -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
      
      <!-- View: 新增表單 -->
      <div id="view-form" class="max-w-5xl mx-auto animate-fade-in">
        <div class="flex justify-between items-end mb-6">
          <div>
            <h2 class="text-2xl font-bold text-slate-800" id="formTitle">新增預約申請</h2>
            <p class="text-slate-500 text-sm mt-1">請填寫下方資訊，申請送出後狀態為「待審核」</p>
          </div>
          <button id="cancelEditBtn" class="hidden px-4 py-2 bg-white text-rose-600 border border-rose-200 rounded-lg text-sm font-medium shadow-sm hover:bg-rose-50 transition">
            <i class="ri-close-circle-line"></i> 取消編輯
          </button>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
          <!-- 左側：輸入表單 -->
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <form id="bookingForm" class="p-6 md:p-8 space-y-6">
              <input type="hidden" id="editId">
              
              <!-- 區塊 1 -->
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                  <i class="ri-user-smile-line"></i> 申請單位資料
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">借用單位 *</label>
                    <input id="unit" type="text" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" placeholder="例如：救災救護科" required>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">聯絡人姓名 *</label>
                    <input id="contact" type="text" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" required>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">聯絡電話 *</label>
                    <input id="phone" type="tel" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" required>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">Email (通知用)</label>
                    <input id="email" type="email" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm">
                  </div>
                </div>
              </div>

              <hr class="border-slate-100">

              <!-- 區塊 2 -->
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                  <i class="ri-map-pin-time-line"></i> 場地與時間
                </h3>
                <div class="space-y-1">
                  <label class="text-xs font-medium text-slate-500">借用場地 *</label>
                  <select id="facility" class="w-full rounded-lg border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" required>
                    <option value="" disabled selected>請選擇...</option>
                    <optgroup label="教學區域">
                      <option>教室701</option>
                      <option>教室702</option>
                      <option>教室703</option>
                    </optgroup>
                    <optgroup label="實體訓練場">
                      <option>空呼氣訓練場</option>
                      <option>燃燒櫃</option>
                      <option>燃燒室</option>
                      <option>大直訓練場</option>
                    </optgroup>
                  </select>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">日期 *</label>
                    <input id="date" type="date" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" required>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">開始時間 *</label>
                    <input id="startTime" type="time" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" required>
                  </div>
                  <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-500">結束時間 *</label>
                    <input id="endTime" type="time" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-2.5 text-sm" required>
                  </div>
                </div>
                <div id="timeError" class="hidden text-xs text-rose-500 font-bold bg-rose-50 p-2 rounded border border-rose-100 flex items-center gap-2">
                   <i class="ri-error-warning-line"></i> 結束時間必須晚於開始時間
                </div>
                
                <div class="space-y-1">
                  <label class="text-xs font-medium text-slate-500">用途說明</label>
                  <textarea id="purpose" rows="3" class="w-full rounded-lg border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition p-3 text-sm resize-none" placeholder="請簡述課程名稱或訓練內容..."></textarea>
                </div>
              </div>

              <!-- 進階功能：批次 -->
              <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden transition-all duration-300">
                <summary class="flex cursor-pointer items-center justify-between p-4 font-medium text-slate-600 hover:bg-slate-100 hover:text-indigo-600 transition">
                  <span class="flex items-center gap-2 text-sm"><i class="ri-calendar-todo-fill"></i> 連續/批次登記工具</span>
                  <i class="ri-arrow-down-s-line transition group-open:rotate-180"></i>
                </summary>
                <div class="p-4 pt-0 border-t border-slate-200 mt-2 space-y-3">
                  <div class="grid grid-cols-2 gap-3 mt-3">
                    <div class="space-y-1">
                       <label class="text-[10px] text-slate-400 uppercase font-bold">區間起始</label>
                       <input id="dateStart" type="date" class="w-full rounded-lg border-slate-300 text-sm p-2">
                    </div>
                    <div class="space-y-1">
                       <label class="text-[10px] text-slate-400 uppercase font-bold">區間結束</label>
                       <input id="dateEnd" type="date" class="w-full rounded-lg border-slate-300 text-sm p-2">
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer select-none">
                      <input id="excludeWeekend" type="checkbox" class="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                      排除六日
                    </label>
                  </div>
                  <div class="space-y-1">
                     <label class="text-[10px] text-slate-400 uppercase font-bold">排除特定日期 (YYYY-MM-DD, 逗號分隔)</label>
                     <input id="excludeDates" type="text" class="w-full rounded-lg border-slate-300 text-sm p-2" placeholder="2025-02-28, 2025-04-05">
                  </div>
                </div>
              </details>

              <div class="pt-2">
                <button type="submit" id="submitBtn" class="w-full rounded-xl bg-slate-900 text-white py-3.5 text-sm font-bold shadow-lg shadow-slate-900/20 hover:bg-indigo-600 hover:shadow-indigo-500/30 active:scale-[0.99] transition-all flex items-center justify-center gap-2">
                  <i class="ri-send-plane-fill"></i> 提交預約申請
                </button>
              </div>
            </form>
          </div>

          <!-- 右側：即時說明/狀態 -->
          <div class="space-y-6">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
              <h3 class="font-bold text-lg mb-2 flex items-center gap-2"><i class="ri-shield-check-line"></i> 預約規則</h3>
              <ul class="space-y-2 text-sm opacity-90 list-disc list-inside leading-relaxed">
                <li>系統採<strong>「登記審核制」</strong>，送出後狀態為待審核。</li>
                <li>請確認時段未被佔用再行申請。</li>
                <li>同一單位連續借用請善用批次工具。</li>
                <li>若需取消，請聯繫管理員或於系統刪除。</li>
              </ul>
            </div>
            
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
               <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wider">近期熱門時段</h3>
               <div class="space-y-3">
                 <div class="flex items-center justify-between text-sm">
                   <span class="text-slate-600">燃燒櫃</span>
                   <span class="px-2 py-0.5 bg-rose-100 text-rose-700 rounded text-xs font-medium">極度搶手</span>
                 </div>
                 <div class="w-full bg-slate-100 rounded-full h-2">
                   <div class="bg-rose-500 h-2 rounded-full" style="width: 85%"></div>
                 </div>
                 
                 <div class="flex items-center justify-between text-sm mt-2">
                   <span class="text-slate-600">空呼氣訓練場</span>
                   <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-medium">繁忙</span>
                 </div>
                 <div class="w-full bg-slate-100 rounded-full h-2">
                   <div class="bg-orange-500 h-2 rounded-full" style="width: 60%"></div>
                 </div>
               </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View: 清單 -->
      <div id="view-list" class="max-w-6xl mx-auto hidden animate-fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[85vh]">
          <!-- Toolbar -->
          <div class="p-4 border-b border-slate-200 flex flex-col lg:flex-row gap-4 justify-between items-center bg-slate-50/50">
            <h2 class="font-bold text-lg text-slate-700 flex items-center gap-2">
              <i class="ri-calendar-check-line text-indigo-500"></i> 預約總表
            </h2>
            <div class="flex flex-wrap gap-2 w-full lg:w-auto">
               <div class="relative group">
                 <i class="ri-calendar-line absolute left-3 top-2.5 text-slate-400 z-10"></i>
                 <input id="filterDate" type="date" class="pl-9 pr-3 py-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition w-full sm:w-auto">
               </div>
               <select id="filterFacility" class="py-2 px-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 bg-white cursor-pointer">
                 <option value="">全部場地</option>
                 <option>教室701</option>
                 <option>教室702</option>
                 <option>教室703</option>
                 <option>空呼氣訓練場</option>
                 <option>燃燒櫃</option>
                 <option>燃燒室</option>
                 <option>大直訓練場</option>
               </select>
               <select id="filterStatus" class="py-2 px-3 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 bg-white cursor-pointer">
                 <option value="">全部狀態</option>
                 <option value="pending">⏳ 待審核</option>
                 <option value="approved">✅ 已核准</option>
               </select>
               <div class="relative flex-1 lg:w-64">
                 <i class="ri-search-line absolute left-3 top-2.5 text-slate-400"></i>
                 <input id="searchInput" type="text" placeholder="搜尋單位/聯絡人..." class="w-full pl-9 pr-3 py-2 rounded-lg border border-slate-300 text-sm focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition">
               </div>
               <button id="clearFilters" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-lg text-sm transition" title="重置">
                 <i class="ri-restart-line"></i>
               </button>
            </div>
          </div>

          <!-- Table Area -->
          <div class="flex-1 overflow-auto relative">
            <table class="w-full text-sm text-left">
              <thead class="bg-slate-50 text-slate-500 font-semibold sticky top-0 shadow-sm z-10">
                <tr>
                  <th class="p-4 whitespace-nowrap w-32">狀態</th>
                  <th class="p-4 whitespace-nowrap w-36">日期</th>
                  <th class="p-4 whitespace-nowrap w-36">時間</th>
                  <th class="p-4 whitespace-nowrap w-40">場地</th>
                  <th class="p-4">單位資訊</th>
                  <th class="p-4 w-32 text-center">操作</th>
                </tr>
              </thead>
              <tbody id="bookingTbody" class="divide-y divide-slate-100"></tbody>
            </table>
            
            <!-- Empty State -->
            <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-slate-400 bg-white/50">
              <i class="ri-inbox-line text-5xl mb-2 text-slate-300"></i>
              <p>查無符合資料</p>
            </div>
          </div>
          
          <div class="p-3 border-t border-slate-200 bg-slate-50 text-xs text-center text-slate-500 flex justify-between px-6">
            <span>資料來源：Local Storage (同步至 Google Sheet)</span>
            <span>共 <span id="countDisplay" class="font-bold">0</span> 筆</span>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-8 right-8 px-6 py-4 bg-slate-800 text-white rounded-xl shadow-2xl flex items-center gap-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <div id="toastIcon" class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-lg"><i class="ri-check-line"></i></div>
    <div>
      <h4 id="toastTitle" class="font-bold text-sm">通知</h4>
      <p id="toastMsg" class="text-xs text-slate-300 mt-0.5">訊息內容</p>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const STORAGE_KEY = 'facility_db_v3';
    
    // --- Helper ---
    const todayISO = () => new Date().toISOString().slice(0, 10);
    const timeToMin = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
    const overlap = (a, b, c, d) => Math.max(a, c) < Math.min(b, d);
    
    // --- State ---
    function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [] } catch { return [] } }
    function save(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); updateBadges(); }

    // --- Init ---
    $('#currentDateDisplay').textContent = todayISO();
    $('#date').value = todayISO();
    updateBadges();

    // --- View Switcher ---
    window.switchView = (viewName) => {
      document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
      $('#view-'+viewName).classList.remove('hidden');
      if(viewName === 'list') renderList();
    };

    // --- Form Logic ---
    // Time Validation
    const checkTime = () => {
       const s = $('#startTime').value, e = $('#endTime').value;
       if(s && e && e <= s) {
         $('#timeError').classList.remove('hidden');
         $('#endTime').classList.add('border-rose-500', 'ring-rose-500');
         return false;
       }
       $('#timeError').classList.add('hidden');
       $('#endTime').classList.remove('border-rose-500', 'ring-rose-500');
       return true;
    };
    $('#startTime').addEventListener('change', checkTime);
    $('#endTime').addEventListener('change', checkTime);

    // Submit
    $('#bookingForm').addEventListener('submit', async e => {
      e.preventDefault();
      if(!checkTime()) { showToast('時間錯誤', '結束時間需晚於開始時間', 'error'); return; }

      const editId = $('#editId').value;
      const formData = {
        unit: $('#unit').value.trim(),
        contact: $('#contact').value.trim(),
        phone: $('#phone').value.trim(),
        email: $('#email').value.trim(),
        facility: $('#facility').value,
        purpose: $('#purpose').value.trim(),
        startTime: $('#startTime').value,
        endTime: $('#endTime').value,
        // 新增狀態欄位：預設為 pending (待審核)
        status: editId ? (load().find(x=>x.id===editId)?.status || 'pending') : 'pending', 
        updatedAt: new Date().toISOString()
      };

      // Handle Dates (Single or Batch)
      const dRaw = $('#date').value;
      const dStart = $('#dateStart').value;
      const dEnd = $('#dateEnd').value;
      const isBatch = (dStart && dEnd && !editId);
      
      let dates = [dRaw];
      if(isBatch) {
        dates = [];
        let curr = new Date(dStart), end = new Date(dEnd);
        const excl = new Set($('#excludeDates').value.split(',').map(s=>s.trim()));
        const skipWeekend = $('#excludeWeekend').checked;
        while(curr <= end) {
           const iso = curr.toISOString().slice(0,10);
           const day = curr.getDay();
           if(!excl.has(iso) && (!skipWeekend || (day!==0 && day!==6))) dates.push(iso);
           curr.setDate(curr.getDate()+1);
        }
      }

      // Conflict Check & Save
      let data = load();
      if(editId) data = data.filter(x => x.id !== editId);
      
      const sTime = timeToMin(formData.startTime);
      const eTime = timeToMin(formData.endTime);
      const created = [], conflicts = [];

      for(const d of dates) {
         const isConflict = data.some(x => x.date === d && x.facility === formData.facility && overlap(sTime, eTime, timeToMin(x.startTime), timeToMin(x.endTime)));
         if(isConflict) { conflicts.push(d); continue; }
         created.push({ id: editId || crypto.randomUUID(), date: d, ...formData });
      }

      if(created.length === 0 && conflicts.length > 0) {
        showToast('預約失敗', '所選時段皆已被佔用', 'error'); return;
      }

      data = [...data, ...created].sort((a,b) => (a.date+a.startTime).localeCompare(b.date+b.startTime));
      save(data);

      // GAS Sync
      if(GAS_ENDPOINT) {
         created.forEach(item => {
           fetch(GAS_ENDPOINT, { method:'POST', mode:'no-cors', body:JSON.stringify(item) }).catch(console.error);
         });
      }

      resetForm();
      const successMsg = editId ? '已更新資料' : `成功送出 ${created.length} 筆申請`;
      const subMsg = conflicts.length ? `(系統自動排除了 ${conflicts.length} 筆衝突)` : '目前狀態：待審核';
      showToast(editId ? '修改成功' : '申請成功', subMsg, 'success');
      if(!editId) switchView('list');
    });

    // --- List & Filter Logic ---
    const filters = { date:'', facility:'', status:'', search:'' };
    ['filterDate','filterFacility','filterStatus','searchInput'].forEach(id => {
       $('#'+id).addEventListener('input', e => {
          const key = id.replace('filter','').replace('Input','').toLowerCase();
          filters[key] = e.target.value.toLowerCase();
          renderList();
       });
    });
    $('#clearFilters').onclick = () => {
       $('#filterDate').value=''; $('#filterFacility').value=''; $('#filterStatus').value=''; $('#searchInput').value='';
       filters.date=''; filters.facility=''; filters.status=''; filters.search='';
       renderList();
    };

    function renderList() {
      const list = load().filter(x => {
         return (!filters.date || x.date === filters.date) &&
                (!filters.facility || x.facility === filters.facility) &&
                (!filters.status || x.status === filters.status) &&
                (!filters.search || (x.unit+x.contact).toLowerCase().includes(filters.search));
      });
      
      const tbody = $('#bookingTbody');
      tbody.innerHTML = '';
      $('#countDisplay').textContent = list.length;
      
      if(list.length === 0) { $('#emptyState').classList.remove('hidden'); return; }
      $('#emptyState').classList.add('hidden');

      list.forEach(x => {
        const statusConfig = x.status === 'approved' 
          ? { bg:'bg-emerald-100', text:'text-emerald-700', label:'已核准', icon:'ri-checkbox-circle-fill' }
          : { bg:'bg-amber-100', text:'text-amber-700', label:'待審核', icon:'ri-time-fill' };
        
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-50 transition group border-b border-slate-50 last:border-0";
        tr.innerHTML = `
          <td class="p-4 align-top">
            <span onclick="toggleStatus('${x.id}')" class="cursor-pointer inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold ${statusConfig.bg} ${statusConfig.text} hover:opacity-80 transition" title="點擊模擬切換狀態(測試用)">
               <i class="${statusConfig.icon}"></i> ${statusConfig.label}
            </span>
          </td>
          <td class="p-4 align-top font-mono text-slate-600">${x.date}</td>
          <td class="p-4 align-top font-mono font-bold text-slate-700">${x.startTime} - ${x.endTime}</td>
          <td class="p-4 align-top">
             <span class="inline-block bg-white border border-slate-200 text-slate-600 text-xs px-2 py-1 rounded shadow-sm">${x.facility}</span>
          </td>
          <td class="p-4 align-top">
             <div class="font-bold text-slate-800">${x.unit}</div>
             <div class="text-xs text-slate-500 mt-0.5 flex items-center gap-1"><i class="ri-user-line"></i> ${x.contact} / ${x.phone}</div>
             ${x.purpose ? `<div class="mt-1.5 text-xs text-slate-400 bg-slate-50 p-1 rounded inline-block max-w-[200px] truncate">${x.purpose}</div>` : ''}
          </td>
          <td class="p-4 align-top text-center">
             <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="editItem('${x.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition"><i class="ri-edit-box-line text-lg"></i></button>
                <button onclick="deleteItem('${x.id}')" class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition"><i class="ri-delete-bin-2-line text-lg"></i></button>
             </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Actions ---
    window.deleteItem = (id) => {
      if(confirm('確定要取消此預約嗎？')) {
        save(load().filter(x => x.id !== id));
        renderList();
        showToast('已刪除', '預約已從清單移除', 'success');
      }
    };

    window.editItem = (id) => {
      const r = load().find(x => x.id === id);
      if(!r) return;
      $('#editId').value = r.id;
      $('#unit').value = r.unit; $('#contact').value = r.contact; $('#phone').value = r.phone; $('#email').value = r.email||'';
      $('#facility').value = r.facility; $('#purpose').value = r.purpose||'';
      $('#date').value = r.date; $('#startTime').value = r.startTime; $('#endTime').value = r.endTime;
      
      // UI Mode
      $('#formTitle').textContent = '編輯預約';
      $('#submitBtn').innerHTML = '<i class="ri-save-3-line"></i> 儲存變更';
      $('#submitBtn').classList.replace('bg-slate-900', 'bg-emerald-600');
      $('#cancelEditBtn').classList.remove('hidden');
      
      switchView('form');
      $('details').removeAttribute('open'); // Hide batch in edit mode
      $('details').classList.add('opacity-50', 'pointer-events-none');
    };

    $('#cancelEditBtn').onclick = resetForm;
    function resetForm() {
       $('#bookingForm').reset();
       $('#editId').value = '';
       $('#date').value = todayISO();
       $('#formTitle').textContent = '新增預約申請';
       $('#submitBtn').innerHTML = '<i class="ri-send-plane-fill"></i> 提交預約申請';
       $('#submitBtn').classList.replace('bg-emerald-600', 'bg-slate-900');
       $('#cancelEditBtn').classList.add('hidden');
       $('details').classList.remove('opacity-50', 'pointer-events-none');
       $('#timeError').classList.add('hidden'); $('#endTime').classList.remove('border-rose-500');
    }

    // Mock Toggle Status (For Admin Test)
    window.toggleStatus = (id) => {
       const data = load();
       const idx = data.findIndex(x => x.id === id);
       if(idx > -1) {
          data[idx].status = data[idx].status === 'pending' ? 'approved' : 'pending';
          save(data);
          renderList();
          showToast('狀態更新', `已變更為 ${data[idx].status==='approved'?'已核准':'待審核'}`, 'success');
       }
    }

    function updateBadges() {
       const pending = load().filter(x => x.status === 'pending').length;
       const b = $('#pendingCount');
       b.textContent = pending;
       if(pending > 0) b.classList.remove('hidden'); else b.classList.add('hidden');
    }

    function showToast(title, msg, type) {
       const t = $('#toast');
       const icon = $('#toastIcon');
       $('#toastTitle').textContent = title;
       $('#toastMsg').textContent = msg;
       if(type==='error') { icon.className='w-8 h-8 rounded-full bg-rose-500 flex items-center justify-center text-lg'; }
       else { icon.className='w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center text-lg'; }
       
       t.classList.remove('translate-y-20', 'opacity-0');
       setTimeout(()=> t.classList.add('translate-y-20', 'opacity-0'), 3000);
    }

    // Export/Import (Functional)
    $('#exportCsvBtn').onclick = () => {
       const d = load(); if(!d.length) return showToast('錯誤','無資料可匯出','error');
       const csv = '\ufeff狀態,ID,單位,聯絡人,電話,場地,用途,日期,開始,結束\n' + 
         d.map(r => `${r.status},${r.id},"${r.unit}","${r.contact}","${r.phone}","${r.facility}","${r.purpose||''}",${r.date},${r.startTime},${r.endTime}`).join('\n');
       const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`booking_${todayISO()}.csv`; a.click();
    };
    $('#exportJsonBtn').onclick = () => {
       const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(load(),null,2)],{type:'application/json'})); a.download=`backup_${todayISO()}.json`; a.click();
    };
    $('#importJsonInput').onchange = (e) => {
       const fr=new FileReader(); fr.readAsText(e.target.files[0]);
       fr.onload=ev=>{ try{ save(JSON.parse(ev.target.result)); renderList(); showToast('成功','資料已還原','success'); }catch{ showToast('失敗','檔案格式錯誤','error'); } e.target.value=''; };
    };

    // Mobile Menu Fix
    window.addEventListener('resize', () => { if(window.innerWidth >= 768) $('aside').classList.remove('hidden', 'absolute', 'h-full'); else $('aside').classList.add('hidden'); });
  </script>
</body>
</html>
